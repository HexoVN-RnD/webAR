<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
    <!-- Remove the text-geometry-component import -->
    <!-- Add Three.js and TextGeometry imports -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        window.TextGeometry = TextGeometry;
    </script>
    <style>
        #name-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        #name-input-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transform: scale(1);
            transition: transform 0.3s ease-in-out;
        }

        #name-input {
            margin: 10px 0;
            padding: 5px;
            font-size: 16px;
        }

        #name-submit {
            padding: 5px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #user-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 100;
        }

        #edit-name {
            margin-left: 10px;
            padding: 2px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .popup-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .popup-buttons {
            margin-top: 15px;
        }

        .popup-buttons button {
            margin: 0 10px;
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .confirm-button {
            background: #4CAF50;
            color: white;
        }

        .cancel-button {
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Update input overlay -->
    <div id="name-input-overlay" class="popup-overlay"
        style="display: flex; background: rgba(0,0,0,0.8); transition: opacity 0.5s;">
        <div id="name-input-container" class="popup-container"
            style="background: #fff; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.6); max-width: 300px;">
            <h2 style="font-family: sans-serif; margin-bottom: 10px;">Xin chào!</h2>
            <p style="font-family: sans-serif; margin-bottom: 10px;">Vui lòng nhập thông tin:</p>
            <input type="text" id="name-input" placeholder="Tên"
                style="width: 100%; margin-bottom: 10px; padding: 8px;">
            <input type="number" id="number-input" placeholder="Số" min="1" max="100"
                style="width: 100%; margin-bottom: 10px; padding: 8px;">
            <button id="name-submit" class="confirm-button"
                style="background: #4CAF50; color: #fff; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">Tiếp
                tục</button>
        </div>
    </div>

    <!-- Add confirmation popup -->
    <div id="confirmation-overlay" class="popup-overlay"
        style="display: none; background: rgba(0,0,0,0.8); transition: opacity 0.5s;">
        <div class="popup-container"
            style="background: #fff; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.6); max-width: 300px;">
            <h2 style="font-family: sans-serif; margin-bottom: 10px;">Xác nhận thông tin</h2>
            <p style="font-family: sans-serif; margin-bottom: 10px;">Tên: <span id="confirm-name"></span></p>
            <p style="font-family: sans-serif; margin-bottom: 10px;">Số đã chọn: <span id="confirm-number"></span></p>
            <div class="popup-buttons" style="display: flex; justify-content: center;">
                <button id="cancel-btn" class="cancel-button"
                    style="background: #f44336; color: #fff; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; margin-right: 10px;">Sửa</button>
                <button id="continue-btn" class="confirm-button"
                    style="background: #4CAF50; color: #fff; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">Tiếp
                    tục</button>
            </div>
        </div>
    </div>

    <!-- Add user info display -->
    <div id="user-info">
        Tên đã nhập: "<span id="user-name"></span>"
        <button id="edit-name">Sửa</button>
    </div>

    <!-- Add autoStart parameter to a-scene -->
    <a-scene mindar-image="imageTargetSrc: ./targets2.mind; filterMinCF:0.0001; filterBeta: 0.0001; autoStart: false"
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <!-- Existing assets -->
            <img id="card" src="./Photo2.jpg" />
            <a-asset-item id="avatarModel" src="./wedding_cake.glb"></a-asset-item>
            <!-- Add logo asset -->
            <img id="logo" src="./assets/logo.png">
            <!-- Gallery assets -->
            <img id="btn-prev" src="./assets/prev.png">
            <img id="btn-next" src="./assets/next.png">
            <img id="btn-play" src="./assets/play.png">
            <img id="btn-pause" src="./assets/pause.png">
            <img id="gallery-icon" src="./assets/gallery.png">

            <!-- Add your gallery items here -->
            <video id="video1" src="./1001.webm" preload="auto" response-type="arraybuffer"></video>
            <video id="video2" src="./kv_neon_webm.webm" preload="auto" response-type="arraybuffer"></video>
            <img id="image1" src="./Photo.jpg">
            <img id="image2" src="./Photo2.jpg">
            <a-asset-item id="fireworkModel" src="./firework.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"
            raycaster="far: 100000; objects: .clickable">
        </a-camera>

        <!-- Update the main entity to include scene-handler -->
        <a-entity mindar-image-target="targetIndex: 0" scene-handler>
            <!-- Updated logo and welcome text -->
            <a-image id="ar-logo" src="#logo" position="0 0.9 0" width="1.2" height="0.4">
            </a-image>
            <a-entity position="0 0.6 0">
                <a-text value="Year End Party" align="center" width="2" color="#FFF" position="0 0 0.1" scale="1 1 1"
                    baseline="center" anchor="center" wrapCount="16"
                    animation="property: scale; to: 1.1 1.1 1.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate">
                </a-text>
            </a-entity>

            <!-- Update welcome text structure -->
            <a-entity id="welcome-text" position="0 0 0" visible="false">
                <!-- Main welcome text with 3D effect -->
                <a-entity id="main-welcome"
                    troika-text="value: Chúc mừng; color: #FFD700; fontSize: 0.5; outlineWidth: 0.02; outlineColor: #FF00FF; align: center; anchor: center; baseline: middle; letterSpacing: 0.5;"
                    troika-text-material="shader: standard; metalness: 1; roughness: 0; emissive: #FFF700; side: double"
                    position="0 0.2 0.1" scale="0.2 0.2 0.2"
                    animation__rotate="property: rotation; to: 0 360 0; dur: 5000; easing: linear; loop: true"
                    animation__scale="property: scale; to: 0.25 0.25 0.25; dur: 1000; dir: alternate; loop: true">
                </a-entity>

                <!-- Personal message with 3D effect -->
                <a-entity id="personal-message-wrapper" position="0 0 0">
                    <a-entity id="personal-message"
                        troika-text="value: test; color: #00ff00; fontSize: 0.4; outlineWidth: 0.005; outlineColor: #FFFFFF; align: center;"
                        troika-text-material="shader: standard; metalness: 0.8; emissive: #00FFAA; side: double"
                        position="0 0 0.1" scale="0.2 0.2 0.2"
                        animation__float="property: position; to: 0 -0.1 0; dur: 2000; dir: alternate; loop: true; easing: easeInOutQuad"
                        animation__glow="property: opacity; to: 0.5; dur: 1000; dir: alternate; loop: true">
                    </a-entity>
                </a-entity>

                <!-- Add fireworks -->
                <a-entity id="firework-left" gltf-model="#fireworkModel" position="-1 0 0" scale="0.03 0.03 0.03"
                    firework animation-mixer="clip: CINEMA_4D_Main">
                </a-entity>

                <a-entity id="firework-right" gltf-model="#fireworkModel" position="1 0 0" scale="0.03 0.03 0.03"
                    firework animation-mixer="clip: CINEMA_4D_Main">
                </a-entity>
            </a-entity>

            <!-- Hide gallery initially -->
            <a-entity id="gallery-container" position="0 0 0" gallery-handler visible="false">
                <!-- Content wrappers -->
                <a-entity id="content-wrapper">
                    <!-- Image 1 -->
                    <a-plane id="image1-display" position="0 0 0.1" width="1.6" height="0.9"
                        material="src: #image1; shader: flat; npot: true" visible="true" class="clickable content-item">
                    </a-plane>
                    <a-text id="image1-text" value="Hinh anh 1" position="0 -0.55 0.1" width="2" align="center"
                        color="#FFFFFF" visible="true">
                    </a-text>

                    <!-- Image 2 -->
                    <a-plane id="image2-display" position="0 0 0.1" width="1.6" height="0.9"
                        material="src: #image2; shader: flat; npot: true" visible="false"
                        class="clickable content-item">
                    </a-plane>
                    <a-text id="image2-text" value="Hinh anh 2" position="0 -0.55 0.1" width="2" align="center"
                        color="#FFFFFF" visible="false">
                    </a-text>

                    <!-- Video 1 -->
                    <a-video id="video1-display" position="0 0 0.1" width="1.6" height="0.9" src="#video1"
                        visible="false" class="clickable content-item">
                    </a-video>
                    <a-text id="video1-text" value="Video 1" position="0 -0.55 0.1" width="2" align="center"
                        color="#FFFFFF" visible="false">
                    </a-text>

                    <!-- Video 2 -->
                    <a-video id="video2-display" position="0 0 0.1" width="1.6" height="0.9" src="#video2"
                        visible="false" class="clickable content-item">
                    </a-video>
                    <a-text id="video2-text" value="Video 2" position="0 -0.55 0.1" width="2" align="center"
                        color="#FFFFFF" visible="false">
                    </a-text>
                </a-entity>

                <!-- Navigation buttons -->
                <a-image id="prev-btn" src="#btn-prev" position="-0.95 0 0.2" height="0.15" width="0.15"
                    class="clickable"
                    animation__scale="property: scale; to: 1.2 1.2 1.2; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"
                    animation__position="property: position; to: -0.9 0.05 0.2; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
                    animation__hover="property: scale; to: 1.5 1.5 1.5; startEvents: mouseenter; dur: 300; dir: normal"
                    animation__leave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 300; dir: normal">
                </a-image>

                <a-image id="next-btn" src="#btn-next" position="0.95 0 0.2" height="0.15" width="0.15"
                    class="clickable"
                    animation__scale="property: scale; to: 1.2 1.2 1.2; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"
                    animation__position="property: position; to: 0.9 0.05 0.2; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
                    animation__hover="property: scale; to: 1.5 1.5 1.5; startEvents: mouseenter; dur: 300; dir: normal"
                    animation__leave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 300; dir: normal">
                </a-image>

                <!-- Update overlay planes to match new dimensions -->
                <a-plane id="video1-overlay" position="0 0 0.11" width="1.6" height="0.9" visible="false"
                    class="clickable" material="color: black; transparent: true; opacity: 0.5">
                </a-plane>
                <a-plane id="video2-overlay" position="0 0 0.11" width="1.6" height="0.9" visible="false"
                    class="clickable" material="color: black; transparent: true; opacity: 0.5">
                </a-plane>
                <a-image id="play-btn" src="#btn-play" position="0 0 0.12" visible="false" scale="0.2 0.2 0.2"
                    material="opacity: 0"
                    animation__fadeIn="property: material.opacity; from: 0; to: 1; dur: 500; startEvents: fadeIn"
                    animation__fadeOut="property: material.opacity; from: 1; to: 0; dur: 500; startEvents: fadeOut">
                </a-image>
            </a-entity>

            <!-- Update gallery toggle position -->
            <a-entity id="gallery-toggle" position="0.8 -0.7 0" visible="false">
                <a-image src="#gallery-icon" width="0.15" height="0.15" class="clickable"
                    animation="property: scale; to: 1.2 1.2 1.2; dur: 1000; dir: alternate; loop: true">
                </a-image>
            </a-entity>
        </a-entity>
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
            import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

            const firebaseConfig = {

                apiKey: "AIzaSyBSvYwZ5VQ5r42zEXx8aLACkln8HVgjqQE",
                authDomain: "yep2025-3f1d9.firebaseapp.com",
                projectId: "yep2025-3f1d9",
                storageBucket: "yep2025-3f1d9.firebasestorage.app",
                messagingSenderId: "482933449467",
                appId: "1:482933449467:web:d63d2949359905e13b465e"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);

            // Initialize Firestore
            const db = getFirestore(app);

            // Function to read from a collection
            async function getDocuments() {
                try {
                    const querySnapshot = await getDocs(collection(db, "default"));
                    querySnapshot.forEach((doc) => {
                        console.log(`${doc.id} =>`, doc.data());
                    });
                } catch (error) {
                    console.error("Error getting documents: ", error);
                }
            }
            // Call the function
            getDocuments();
        </script>

        <script>
            const nameInput = document.getElementById('name-input');
            nameInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
            AFRAME.registerComponent('gallery-handler', {
                init: function () {
                    const galleryItems = [
                        { type: 'image', id: '#image1', displayId: 'image1-display', textId: 'image1-text' },
                        { type: 'image', id: '#image2', displayId: 'image2-display', textId: 'image2-text' },
                        { type: 'video', id: '#video1', displayId: 'video1-display', textId: 'video1-text' },
                        { type: 'video', id: '#video2', displayId: 'video2-display', textId: 'video2-text' }
                    ];

                    let currentIndex = 0;
                    const playBtn = document.querySelector('#play-btn');
                    const video1Overlay = document.querySelector('#video1-overlay');
                    const video2Overlay = document.querySelector('#video2-overlay');

                    // Next button
                    document.querySelector('#next-btn').addEventListener('click', () => {
                        console.log('Next clicked');
                        hideCurrentItem();
                        currentIndex = (currentIndex + 1) % galleryItems.length;
                        showCurrentItem();
                    });

                    // Previous button
                    document.querySelector('#prev-btn').addEventListener('click', () => {
                        console.log('Prev clicked');
                        hideCurrentItem();
                        currentIndex = (currentIndex - 1 + galleryItems.length) % galleryItems.length;
                        showCurrentItem();
                    });

                    // Attach click events to video entities instead
                    function toggleVideo() {
                        const currentItem = galleryItems[currentIndex];
                        if (currentItem.type !== 'video') return;

                        const video = document.querySelector(currentItem.id);
                        const overlay = getOverlay(currentItem);

                        if (video.paused) {
                            video.play();
                            playBtn.setAttribute('src', '#btn-pause');
                            playBtn.emit('fadeOut');
                            overlay.setAttribute('visible', false);
                        } else {
                            video.pause();
                            playBtn.setAttribute('src', '#btn-play');
                            playBtn.emit('fadeIn');
                            overlay.setAttribute('visible', true);
                        }
                    }

                    function getOverlay(item) {
                        return item.id === '#video1' ? video1Overlay : video2Overlay;
                    }

                    // Update hideCurrentItem function
                    function hideCurrentItem() {
                        const currentItem = galleryItems[currentIndex];
                        document.querySelector(`#${currentItem.displayId}`).setAttribute('visible', false);
                        document.querySelector(`#${currentItem.textId}`).setAttribute('visible', false);
                    }

                    function showCurrentItem() {
                        const currentItem = galleryItems[currentIndex];
                        document.querySelector(`#${currentItem.displayId}`).setAttribute('visible', true);
                        document.querySelector(`#${currentItem.textId}`).setAttribute('visible', true);

                        // Reset all overlays first
                        video1Overlay.setAttribute('visible', false);
                        video2Overlay.setAttribute('visible', false);

                        // Show/hide play button and setup video elements
                        if (currentItem.type === 'video') {
                            const video = document.querySelector(currentItem.id);
                            const overlay = getOverlay(currentItem);

                            video.currentTime = 0;
                            playBtn.setAttribute('visible', true);
                            playBtn.setAttribute('src', '#btn-pause');

                            // Auto play the video
                            video.play();
                            overlay.setAttribute('visible', false);

                            // Setup click handlers
                            overlay.removeEventListener('click', toggleVideo);
                            overlay.addEventListener('click', toggleVideo);

                            const videoDisplay = document.querySelector('#' + currentItem.displayId);
                            videoDisplay.removeEventListener('click', toggleVideo);
                            videoDisplay.addEventListener('click', toggleVideo);

                            playBtn.emit('fadeOut');
                        } else {
                            playBtn.setAttribute('visible', false);
                        }
                    }

                    // Show initial item
                    showCurrentItem();
                }
            });

            AFRAME.registerComponent('scene-handler', {
                init: function () {
                    let userData = {
                        name: '',
                        number: ''
                    };

                    const nameOverlay = document.getElementById('name-input-overlay');
                    const confirmationOverlay = document.getElementById('confirmation-overlay');
                    const welcomeText = document.getElementById('welcome-text');
                    const galleryContainer = document.getElementById('gallery-container');
                    const galleryToggle = document.getElementById('gallery-toggle');

                    // Get AR system reference
                    const sceneEl = document.querySelector('a-scene');
                    const arSystem = sceneEl.systems["mindar-image-system"];

                    // Initial form submission
                    document.getElementById('name-submit').addEventListener('click', () => {
                        userData.name = document.getElementById('name-input').value.trim();
                        userData.number = document.getElementById('number-input').value;

                        if (userData.name && userData.number) {
                            document.getElementById('confirm-name').textContent = userData.name;
                            document.getElementById('confirm-number').textContent = userData.number;

                            nameOverlay.style.opacity = '0';
                            setTimeout(() => {
                                nameOverlay.style.display = 'none';
                                confirmationOverlay.style.display = 'flex';
                                setTimeout(() => confirmationOverlay.style.opacity = '1', 50);
                            }, 500);
                        }
                    });

                    // Confirmation handlers
                    document.getElementById('cancel-btn').addEventListener('click', () => {
                        arSystem.stop();
                        confirmationOverlay.style.opacity = '0';
                        setTimeout(() => {
                            confirmationOverlay.style.display = 'none';
                            nameOverlay.style.display = 'flex';
                            setTimeout(() => nameOverlay.style.opacity = '1', 50);
                        }, 500);
                    });

                    document.getElementById('continue-btn').addEventListener('click', () => {
                        confirmationOverlay.style.opacity = '0';
                        setTimeout(() => {
                            confirmationOverlay.style.display = 'none';

                            // Update welcome text
                            const personalMessage = document.querySelector('#personal-message');
                            personalMessage.setAttribute('troika-text', `value:${userData.name} đã chọn số ${userData.number}`);

                            // Show welcome text and start fireworks
                            welcomeText.setAttribute('visible', true);
                            document.querySelector('#firework-left').components.firework.play();
                            document.querySelector('#firework-right').components.firework.play();

                            galleryToggle.setAttribute('visible', true);

                            // Start AR system
                            arSystem.start();
                        }, 500);
                    });

                    // Gallery toggle handler
                    galleryToggle.addEventListener('click', function () {
                        const isGalleryVisible = galleryContainer.getAttribute('visible');
                        galleryContainer.setAttribute('visible', !isGalleryVisible);
                        welcomeText.setAttribute('visible', isGalleryVisible);
                    });

                    // Add handlers to stop AR when editing
                    document.getElementById('edit-name').addEventListener('click', () => {
                        arSystem.stop();
                    });
                }
            });

            // Add name handling logic
            document.addEventListener('DOMContentLoaded', function () {
                const overlay = document.getElementById('name-input-overlay');
                const nameInput = document.getElementById('name-input');
                const submitBtn = document.getElementById('name-submit');
                const userInfo = document.getElementById('user-info');
                const userName = document.getElementById('user-name');
                const editBtn = document.getElementById('edit-name');
                const scene = document.querySelector('a-scene');

                // Wait for scene to load before getting arSystem
                let arSystem;
                scene.addEventListener('loaded', function () {
                    arSystem = scene.systems["mindar-image-system"];
                });

                function showNameInput() {
                    overlay.style.opacity = '1';
                    overlay.style.display = 'flex';
                    nameInput.focus();
                    // Only stop AR if system is initialized
                    if (arSystem) {
                        arSystem.stop();
                    }
                }

                function hideNameInput() {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 500);
                }

                function showUserInfo() {
                    userInfo.style.display = 'block';
                    setTimeout(() => {
                        userInfo.style.opacity = '1';
                    }, 100);
                }

                function submitName() {
                    const name = nameInput.value.trim();
                    if (name) {
                        userName.textContent = name;
                        hideNameInput();
                        showUserInfo();
                        // // Only start AR if system is initialized
                        // if (arSystem) {
                        //     arSystem.start();
                        // }
                    }
                }

                // Event listeners
                submitBtn.addEventListener('click', submitName);
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') submitName();
                });

                editBtn.addEventListener('click', () => {
                    showNameInput();
                });

                // Show input on load
                showNameInput();
            });

            AFRAME.registerComponent('firework', {
                init: function () {
                    this.el.addEventListener('animationcomplete', () => {
                        // Reset animation when complete
                        this.el.object3D.visible = true;
                        this.el.setAttribute('animation-mixer', 'loop: repeat');
                    });
                },
                play: function () {
                    this.el.object3D.visible = true;
                    this.el.setAttribute('animation-mixer', 'loop: repeat');
                },
                pause: function () {
                    this.el.object3D.visible = false;
                    this.el.removeAttribute('animation-mixer');
                }
            });
        </script>
</body>

</html>